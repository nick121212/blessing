{"version":3,"sources":["../../src/lib/application.js"],"names":["SpaRouter","keys","app","spaEureca","fn","callback","eureca","exports","extend","forEach","val","key","data","context","async","retId","routerKey","clone","params","proxy","ctx","next","hasOwnProperty","func","SpaServer","config","_server","_connections","init","events","transport","allow","on","connection","id","socket","emit","SpaClient","_client","uri","prefix","isReady","serverProxy","Spa","_maxJobs","err","console","log","jobs","return","body","spaClient","spaServer","attach"],"mappings":"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","file":"application.js","sourcesContent":["/**\n * Created by NICK on 2016/12/16.\n */\n\nimport { Server, Client } from \"eureca.io\";\nimport { EventEmitter } from \"events\";\nimport { Compose } from \"./compose\";\nimport _ from \"lodash\";\n\nexport class SpaRouter extends EventEmitter {\n    constructor() {\n        super();\n\n        this.keys = {};\n    }\n\n    get eureca() {\n        return null;\n    }\n\n    /**\n     * 开始中间件\n     */\n    attach(app, spaEureca) {\n        let fn = app.callback();\n\n        spaEureca.eureca.exports = _.extend({}, spaEureca.eureca.exports || {});\n        _.forEach(this.keys, (val, key) => {\n            spaEureca.eureca.exports[key] = function(data) {\n                let context = this;\n                context.async = true;\n                if (!context.retId) return;\n                fn({\n                    routerKey: key,\n                    context: _.clone(context),\n                    params: data || {},\n                    proxy: spaEureca\n                });\n            };\n        });\n\n        return async(ctx, next) => {\n            if (this.keys.hasOwnProperty(ctx.routerKey)) {\n                await this.keys[ctx.routerKey](ctx, next);\n            } else {\n                await next();\n            }\n        };\n    }\n\n    /**\n     * 添加路由方法\n     */\n    attachRouteToSocket(key, func) {\n        this.keys[key] = func;\n    }\n}\n\nexport class SpaServer extends SpaRouter {\n    constructor(config) {\n        super();\n\n        this._server = null;\n        this._connections = {};\n\n        this.init(config);\n    }\n\n    get eureca() {\n        return this._server;\n    }\n\n    get connections() {\n        return this._connections;\n    }\n\n    attach(app) {\n        return super.attach(app, this);\n    }\n\n    init(config, events = {}) {\n        this._server = new Server({\n            transport: config.transport,\n            allow: config.allow || []\n        });\n        this._server.exports = {};\n\n        _.forEach(events, (fn, key) => {\n            if (key !== \"connect\" && key !== \"disconnect\") {\n                this._server.on(key, (data) => {\n                    fn(this, data);\n                });\n            }\n        });\n\n        this._server.on(\"connect\", (connection) => {\n            this._connections[connection.id] = {\n                socket: connection\n            };\n            this.emit(\"onconnect\", connection, this._connections[connection.id]);\n        });\n        this._server.on(\"disconnect\", (connection) => {\n            if (this._connections[connection.id]) {\n                delete this._connections[connection.id];\n            }\n            this.emit(\"ondisconnect\", connection);\n        });\n        return this._server;\n    }\n}\n\nexport class SpaClient extends SpaRouter {\n    constructor(config) {\n        super();\n        this._client = null;\n        this.init(config);\n    }\n\n    get connections() {\n        return {};\n    }\n\n    get eureca() {\n        return this._client;\n    }\n\n    get proxy() {\n        if (this._client && this._client.isReady()) {\n            return this._client.serverProxy;\n        }\n    }\n\n    attach(app) {\n        return super.attach(app, this);\n    }\n\n    init(config, events = {}) {\n        this._client = new Client({\n            uri: config.uri,\n            prefix: config.prefix || \"\"\n        });\n\n        _.forEach(events, (fn, key) => {\n            this._client.on(key, (data) => {\n                fn(this, data);\n            });\n        });\n\n        this._client.on(\"ready\", (proxy) => {\n            this.emit(\"ready\", proxy);\n        });\n    }\n}\n\nexport class Spa extends Compose {\n    constructor(_maxJobs) {\n        super(_maxJobs);\n    }\n\n    onComplete(ctx) {\n        if (ctx.err) {\n            console.log(\"onComplete-----\", ctx.err);\n        }\n        console.log(\"onComplete-----\", ctx.routerKey, ctx.app.jobs, \"retId:\", ctx.context.retId);\n        super.onComplete(ctx);\n        ctx.context.return && ctx.context.return(ctx.err || ctx.body);\n    }\n\n    initClient(config) {\n        this.spaClient = new SpaClient(config);\n    }\n\n    initServer(config, app) {\n        this.spaServer = new SpaServer(config);\n        this.spaServer.eureca.attach(app);\n    }\n}"]}